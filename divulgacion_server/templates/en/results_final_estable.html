<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binding Energy Stability - Results Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            color: #333;
            font-size: 2em;
        }
        
        h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .back-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }
        
        .two-column-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            height: 500px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
            animation: pulseStatus 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #f44336;
        }
        
        @keyframes pulseStatus {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .connection-status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>‚öõÔ∏è Isotope Stability Activity Results</h1>
                <div class="connection-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
            <!-- <a href="/" class="back-btn">‚Üê Back to Main</a> -->
        </div>
        
        <!-- Statistics -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalSubmissions">0</div>
                <div class="stat-label">Responses Received</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgAa">-</div>
                <div class="stat-label">Avg a<sub>a</sub> (MeV)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgAv">-</div>
                <div class="stat-label">Avg a<sub>v</sub> (MeV)</div>
            </div>
        </div>
        
        <!-- Binding Energy Plot -->
        <div class="section">
            <h2>üìä Binding Energy per Nucleon vs Mass Number</h2>
            <div class="chart-container">
                <canvas id="beChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        console.log('Binding Energy results page loaded - initializing...');
        
        // LDM parameters (constants)
        const LDM_PARAMS = {
            a_v: 16,
            a_s: 18.8,
            a_c: 0.55,
            a_a: 17.58,
            a_p: 10.06
        };
        
        // Pre-compute binding energy data
        let precomputedBE = null;
        
        // Data storage
        let allMessages = [];
        let chart = null;
        
        // Range datasets
        let aaRangeDataset = null;
        let avRangeDataset = null;
        
        // Initialize Socket.IO connection
        const socket = io();
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Socket.IO connected!');
            document.getElementById('statusText').textContent = 'Live Results';
            document.getElementById('statusIndicator').className = 'status-indicator connected';
        });
        
        socket.on('disconnect', function() {
            console.log('Socket.IO disconnected');
            document.getElementById('statusText').textContent = 'Disconnected - Reconnecting...';
            document.getElementById('statusIndicator').className = 'status-indicator disconnected';
        });
        
        socket.on('connect_error', function(error) {
            console.error('Socket.IO connection error:', error);
        });
        
        // Liquid Drop Model calculation
        function ldmModel(A, Z, a_v, a_s, a_c, a_a, a_p) {
            const V = a_v * A;
            const S = a_s * Math.pow(A, 2/3);
            const C = a_c * Z * (Z - 1) / Math.pow(A, 1/3);
            const Y = a_a * Math.pow(A - 2 * Z, 2) / A;
            
            // Pairing term
            let P = 0;
            if (A % 2 === 0) {
                if (Z % 2 === 0) P = +a_p / Math.sqrt(A); // even-even
                else P = -a_p / Math.sqrt(A);             // odd-odd
            }

            const BE = V - S - C - Y + P;
            return BE / A; // binding energy per nucleon
        }

        
        // Pre-compute binding energy for all A values
        function precomputeBindingEnergy() {
            const data = [];
            
            // A from 1 to 250, Z approximated as A/2 for stability line
            for (let A = 8; A <= 75; A++) {
                const Z = 8//Math.round(A / 2);
                const BE_per_nucleon = ldmModel(
                    A, Z,
                    LDM_PARAMS.a_v,
                    LDM_PARAMS.a_s,
                    LDM_PARAMS.a_c,
                    LDM_PARAMS.a_a,
                    LDM_PARAMS.a_p
                );
                
                data.push({
                    x: A,
                    y: BE_per_nucleon
                });
            }
            
            return data;
        }
        
        // Initialize chart
        function initChart() {
            precomputedBE = precomputeBindingEnergy();
            
            // Find appropriate y-axis range
            const yValues = precomputedBE.map(d => d.y);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            
            // Extend range a bit into negative values
            const yAxisMin = Math.min(-2, yMin - 1);
            const yAxisMax = yMax + 1;
            
            const ctx = document.getElementById('beChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Binding Energy per Nucleon (LDM)',
                            data: precomputedBE,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.1,
                            order: 1  // Draw on top
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Mass Number (A)',
                                font: {
                                    size: 14
                                }
                            },
                            min: 8,
                            max: 75
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Binding Energy per Nucleon (MeV)',
                                font: {
                                    size: 14
                                }
                            },
                            min: yAxisMin,
                            max: yAxisMax
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Nuclear Stability: BE/A vs Mass Number'
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: false
                        },
                        annotation: {
                            annotations: {}
                        }
                    }
                }
            });
        }
        
        // Calculate averages from messages
        function calculateAverages(messages) {
            if (messages.length === 0) return null;
            
            const sums = {
                A_min_a_a: 0,
                A_max_a_a: 0,
                A_min_a_v: 0,
                A_max_a_v: 0
            };
            
            let count_a = 0;
            let count_v = 0;
            
            console.log('=== Starting average calculation ===');
            console.log('Total messages to process:', messages.length);
            
            messages.forEach((msg, index) => {
                // Check if message has required fields
                const hasAa = msg.A_min_a_a !== undefined && msg.A_max_a_a !== undefined;
                const hasAv = msg.A_min_a_v !== undefined && msg.A_max_a_v !== undefined;
                
                console.log(`Message ${index}:`, {
                    A_min_a_a: msg.A_min_a_a,
                    A_max_a_a: msg.A_max_a_a,
                    A_min_a_v: msg.A_min_a_v,
                    A_max_a_v: msg.A_max_a_v,
                    hasAa: hasAa,
                    hasAv: hasAv
                });
                
                if (hasAa && hasAv) {
                    // Parse values to ensure they're numbers
                    const minAa = parseFloat(msg.A_min_a_a);
                    const maxAa = parseFloat(msg.A_max_a_a);
                    const minAv = parseFloat(msg.A_min_a_v);
                    const maxAv = parseFloat(msg.A_max_a_v);
                    
                    // Check if all values are valid numbers
                    if (!isNaN(minAa) && !isNaN(maxAa) && !isNaN(minAv) && !isNaN(maxAv)) {
                        sums.A_min_a_a += minAa;
                        sums.A_max_a_a += maxAa;
                        sums.A_min_a_v += minAv;
                        sums.A_max_a_v += maxAv;
                        if (minAa !== 0){
                            count_a++;
                        }
                        if (minAv !==0){
                            count_v++;
                        }
                        console.log(`  ‚úì Added to sums. Running totals:`, {
                            A_min_a_a: sums.A_min_a_a,
                            A_max_a_a: sums.A_max_a_a,
                            A_min_a_v: sums.A_min_a_v,
                            A_max_a_v: sums.A_max_a_v,
                            count: count_a
                        });
                    } else {
                        console.log(`  ‚úó Skipped - invalid numbers`);
                    }
                } else {
                    console.log(`  ‚úó Skipped - missing fields`);
                }
            });
            
            console.log('Final sums:', sums);
            console.log('Valid message count:', count_a);
            
            if (count_a === 0) return null;
            
            const averages = {
                A_min_a_a: sums.A_min_a_a / count_a,
                A_max_a_a: sums.A_max_a_a / count_a,
                A_min_a_v: sums.A_min_a_v / count_v,
                A_max_a_v: sums.A_max_a_v / count_v,
                count : count_a
            };
            
            console.log('Calculated averages:', averages);
            console.log('Valid number ', count_a)
            console.log('=== Average calculation complete ===');
            
            return averages; //{averages, count_a};
        }
        
        // Update vertical range bands
        function updateRangeBands() {
            const averages = calculateAverages(allMessages);
            
            if (!averages) {
                // Remove all annotations
                chart.options.plugins.annotation.annotations = {};
                chart.update();
                return;
            }
            
            console.log('Adding range bands:', {
                aa: { min: averages.A_min_a_a, max: averages.A_max_a_a },
                av: { min: averages.A_min_a_v, max: averages.A_max_a_v }
            });
            
            // Use annotation plugin to draw filled boxes
            chart.options.plugins.annotation.annotations = {
                aaRange: {
                    type: 'box',
                    xMin: averages.A_min_a_a,
                    xMax: averages.A_max_a_a,
                    yMin: chart.options.scales.y.min,
                    yMax: chart.options.scales.y.max,
                    backgroundColor: 'rgba(255, 99, 132, 0.15)',
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    borderWidth: 2,
                    label: {
                        display: true,
                        content: 'a_a Range',
                        position: 'start',
                        color: 'rgba(255, 99, 132, 1)',
                        font: {
                            size: 11
                        }
                    }
                },
                avRange: {
                    type: 'box',
                    xMin: averages.A_min_a_v,
                    xMax: averages.A_max_a_v,
                    yMin: chart.options.scales.y.min,
                    yMax: chart.options.scales.y.max,
                    backgroundColor: 'rgba(75, 192, 192, 0.15)',
                    borderColor: 'rgba(75, 192, 192, 0.5)',
                    borderWidth: 2,
                    label: {
                        display: true,
                        content: 'a_v Range',
                        position: 'start',
                        color: 'rgba(75, 192, 192, 1)',
                        font: {
                            size: 11
                        }
                    }
                }
            };
            
            chart.update();
        }
        
        // Update statistics display
        function updateStats() {
            //document.getElementById('totalSubmissions').textContent = allMessages.length;
            
            //const averages = calculateAverages(allMessages);
            console.log("number of messages", allMessages.length)
            const averages = calculateAverages(allMessages);
            console.log('Number of logs', averages)
            document.getElementById('totalSubmissions').textContent = averages.count;
            if (averages) {
                const avgAa = (averages.A_min_a_a + averages.A_max_a_a) / 2;
                const avgAv = (averages.A_min_a_v + averages.A_max_a_v) / 2;
                document.getElementById('avgAa').textContent = avgAa.toFixed(1);
                document.getElementById('avgAv').textContent = avgAv.toFixed(1);
            } else {
                document.getElementById('avgAa').textContent = '-';
                document.getElementById('avgAv').textContent = '-';
            }
        }
        
        // Load existing messages on page load
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                console.log('Loaded messages:', data.messages);
                
                allMessages = data.messages;
                updateRangeBands();
                updateStats();
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Listen for new messages via Socket.IO
        socket.on('new_data', function(message) {
            loadMessages();
            console.log('New message received via socket:', message);

        });
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('Page load complete, initializing...');
            initChart();
            loadMessages();
        });
    </script>
</body>
</html>
